<div class="top-of-the-book-container">
  <!-- Toast for trade notifications -->
  <p-toast position="top-right"></p-toast>
  
  <div class="tob-header">
    <h3>Top of the Book</h3>
    <span class="row-count">{{ marketDataRows.length }} instruments</span>
  </div>
  
  <div class="tob-grid">
    <!-- Header Row -->
    <div class="tob-row tob-header-row">
      <div class="tob-cell tob-cell-desc">Description</div>
      <div class="tob-cell tob-cell-bid-size">Bid Size</div>
      <div class="tob-cell tob-cell-bid">Best Bid</div>
      <div class="tob-cell tob-cell-ask">Best Ask</div>
      <div class="tob-cell tob-cell-ask-size">Ask Size</div>
    </div>
    
    <!-- Data Rows -->
    @if (marketDataRows.length === 0) {
      <div class="tob-empty">
        <span>Waiting for market data...</span>
      </div>
    } @else {
      @for (row of marketDataRows; track trackByRow($index, row)) {
        <div class="tob-row tob-data-row">
          <div class="tob-cell tob-cell-desc">{{ row.Desc }}</div>
          <div 
            class="tob-cell tob-cell-bid-size tob-cell-interactive"
            (click)="showTradingPopover($event, row, 'sell')">
            {{ formatQuantity(row.BestBidQty) }}
          </div>
          <div class="tob-cell tob-cell-bid">{{ formatPrice(row.BestBidPrice) }}</div>
          <div class="tob-cell tob-cell-ask">{{ formatPrice(row.BestAskPrice) }}</div>
          <div 
            class="tob-cell tob-cell-ask-size tob-cell-interactive"
            (click)="showTradingPopover($event, row, 'buy')">
            {{ formatQuantity(row.BestAskQty) }}
          </div>
        </div>
      }
    }
  </div>
</div>

<!-- Trading Popover - Real-time updates -->
<p-popover #tradingPopover [dismissable]="true">
  <div class="trading-popover" *ngIf="tradingData && liveRow">
    <div class="trading-popover-header">
      <span class="trading-side" [class.sell]="tradingData.side === 'sell'" [class.buy]="tradingData.side === 'buy'">
        {{ tradingData.side === 'buy' ? 'BUY' : 'SELL' }}
      </span>
      <span class="trading-instrument">{{ liveRow.Desc }}</span>
    </div>
    
    <div class="trading-popover-details">
      <div class="trading-row">
        <span class="trading-label">Instrument:</span>
        <span class="trading-value">{{ liveRow.Desc }}</span>
      </div>
      <div class="trading-row trading-row-price">
        <span class="trading-label">Price:</span>
        <span class="trading-value trading-price-group">
          <span class="trading-price" [class.bid-price]="tradingData.side === 'sell'" [class.ask-price]="tradingData.side === 'buy'">
            {{ formatPrice(livePrice) }}
          </span>
          <span class="trading-size">{{ formatQuantity(liveSize) }}</span>
        </span>
      </div>
      <div class="trading-row">
        <span class="trading-label">Quantity:</span>
        <div class="qty-spinner">
          <button type="button" class="qty-btn qty-decrement" (click)="decrementQuantity()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
          <input 
            type="number" 
            class="qty-input" 
            [(ngModel)]="tradingData.quantity" 
            [min]="1"
            (change)="validateQuantity()">
          <button type="button" class="qty-btn qty-increment" (click)="incrementQuantity()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <div class="trading-popover-actions">
      <div class="trading-book-select">
        <label class="trading-label">Book:</label>
        <p-select 
          [(ngModel)]="tradingData.book" 
          [options]="tradingBooks" 
          optionLabel="name"
          placeholder="Select Book"
          [style]="{ width: '140px' }">
        </p-select>
      </div>
      <p-button 
        [label]="tradingData.side === 'buy' ? 'Buy' : 'Sell'"
        [severity]="tradingData.side === 'buy' ? 'success' : 'danger'"
        (onClick)="executeTrade()"
        styleClass="trading-action-btn">
      </p-button>
    </div>
  </div>
</p-popover>
